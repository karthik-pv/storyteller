<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Story Image Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #000000;
        min-height: 100vh;
        color: #ffffff;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 40px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        margin-bottom: 30px;
      }

      h1 {
        text-align: center;
        font-size: 2.5rem;
        font-weight: 300;
        margin-bottom: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .mode-selector {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        justify-content: center;
      }

      .mode-btn {
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        color: #ffffff;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      .mode-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        border-color: rgba(102, 126, 234, 0.3);
      }

      .mode-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: rgba(102, 126, 234, 0.5);
      }

      .mode-content {
        display: none;
      }

      .mode-content.active {
        display: block;
      }

      .section {
        margin-bottom: 40px;
      }

      .section h3 {
        font-size: 1.3rem;
        font-weight: 400;
        margin-bottom: 20px;
        color: #e1e1e1;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #e1e1e1;
        font-size: 14px;
      }

      .form-group select,
      .form-group input {
        width: 100%;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: #ffffff;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .form-group select:focus,
      .form-group input:focus {
        outline: none;
        border-color: rgba(102, 126, 234, 0.5);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
      }

      .form-group select option {
        background: #1a1a1a;
        color: #ffffff;
      }

      .random-story-section {
        text-align: center;
        padding: 30px;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-radius: 15px;
        margin-bottom: 20px;
      }

      .random-story-section h4 {
        color: #4ade80;
        margin-bottom: 15px;
      }

      .file-upload {
        position: relative;
        display: inline-block;
        width: 100%;
      }

      .file-upload input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-upload-label {
        display: block;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .file-upload-label:hover {
        border-color: rgba(102, 126, 234, 0.5);
        background: rgba(102, 126, 234, 0.1);
      }

      .avatar-preview {
        margin-top: 20px;
        text-align: center;
        display: none;
      }

      .avatar-preview img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 15px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }

      .btn {
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 15px;
        color: #ffffff;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-align: center;
        display: inline-block;
        text-decoration: none;
        min-width: 150px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 10px 30px rgba(255, 255, 255, 0.1);
      }

      .story-display {
        display: none;
        margin-top: 30px;
      }

      .story-slide {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .story-slide h4 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .story-text {
        color: #e1e1e1;
        line-height: 1.6;
        margin-bottom: 15px;
      }

      .story-image {
        text-align: center;
        margin-top: 15px;
      }

      .story-image img {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #667eea;
      }

      .loading::after {
        content: "...";
        animation: dots 1.5s infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: "";
        }
        40% {
          content: ".";
        }
        60% {
          content: "..";
        }
        80%,
        100% {
          content: "...";
        }
      }

      .progress-container {
        margin-top: 30px;
        display: none;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 0%;
      }

      .progress-text {
        text-align: center;
        color: #b1b1b1;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .results-container {
        margin-top: 30px;
        display: none;
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .image-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center;
      }

      .image-card img {
        max-width: 100%;
        border-radius: 10px;
        margin-bottom: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }

      .image-card .prompt-text {
        color: #b1b1b1;
        font-size: 12px;
        line-height: 1.4;
        margin-bottom: 10px;
      }

      .download-section {
        text-align: center;
        margin-top: 30px;
        padding: 30px;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-radius: 15px;
        display: none;
      }

      .download-section h4 {
        color: #4ade80;
        margin-bottom: 15px;
      }

      .download-section p {
        color: #b1b1b1;
        margin-bottom: 20px;
      }

      /* Manual prompt styles */
      .prompt-container {
        margin-bottom: 15px;
        position: relative;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }

      .prompt-container textarea {
        flex: 1;
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        color: #ffffff;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        min-height: 80px;
      }

      .prompt-container textarea:focus {
        outline: none;
        border-color: rgba(102, 126, 234, 0.5);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
      }

      .prompt-container textarea::placeholder {
        color: #888;
      }

      .prompt-number {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        margin-top: 15px;
        flex-shrink: 0;
      }

      .remove-prompt-btn {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #fca5a5;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
        flex-shrink: 0;
      }

      .remove-prompt-btn:hover {
        background: rgba(239, 68, 68, 0.3);
        border-color: rgba(239, 68, 68, 0.5);
      }

      .add-prompt-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: rgba(17, 153, 142, 0.2);
        border: 1px solid rgba(17, 153, 142, 0.3);
        color: #6ee7b7;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        margin-top: 10px;
      }

      .add-prompt-btn:hover {
        background: rgba(17, 153, 142, 0.3);
        border-color: rgba(17, 153, 142, 0.5);
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px 15px;
        }

        .glass-card {
          padding: 25px;
        }

        h1 {
          font-size: 2rem;
        }

        .mode-selector {
          flex-direction: column;
          gap: 10px;
        }

        .image-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>AI Story Image Generator</h1>

      <div class="glass-card">
        <!-- Mode Selection -->
        <div class="mode-selector">
          <button class="mode-btn active" onclick="switchMode('story')">
            üìö Generate Story
          </button>
          <button class="mode-btn" onclick="switchMode('manual')">
            ‚úèÔ∏è Manual Prompts
          </button>
        </div>

        <!-- Story Generation Mode -->
        <div id="story-mode" class="mode-content active">
          <!-- Avatar Upload for Story - MOVED TO TOP -->
          <div class="section">
            <h3>üé≠ Upload Your Avatar First</h3>
            <p style="color: #b1b1b1; margin-bottom: 15px">
              Upload your avatar image to ensure your character appears in all
              story images.
            </p>
            <div class="file-upload">
              <input
                type="file"
                id="story-avatar"
                accept="image/*"
                onchange="previewStoryAvatar()"
              />
              <label for="story-avatar" class="file-upload-label">
                <div>üì∏ Click to upload your avatar</div>
                <small>PNG, JPG, or GIF (max 10MB)</small>
              </label>
            </div>
            <div id="story-avatar-preview" class="avatar-preview">
              <img id="story-avatar-img" src="" alt="Avatar preview" />
              <p>Avatar uploaded successfully!</p>
            </div>
          </div>

          <div
            class="section"
            id="story-creation-section"
            style="display: none"
          >
            <h3>üìö Create Your Story</h3>

            <!-- Random Story Option -->
            <div class="random-story-section">
              <h4>üé≤ Feeling Lucky?</h4>
              <p style="color: #b1b1b1; margin-bottom: 15px">
                Let us create a random story for you!
              </p>
              <button class="btn btn-secondary" onclick="generateRandomStory()">
                Generate Random Story
              </button>
            </div>

            <!-- Manual Category Selection -->
            <div class="form-group">
              <label for="category">Story Category:</label>
              <select id="category" onchange="updateSubcategories()">
                <option value="">Select a category...</option>
              </select>
            </div>

            <div class="form-group">
              <label for="subcategory">Story Theme:</label>
              <select id="subcategory" disabled>
                <option value="">Select a theme...</option>
              </select>
            </div>

            <div class="form-group">
              <label for="num-slides">Number of Story Slides:</label>
              <select id="num-slides">
                <option value="3">3 slides</option>
                <option value="4">4 slides</option>
                <option value="5" selected>5 slides</option>
                <option value="6">6 slides</option>
                <option value="7">7 slides</option>
                <option value="8">8 slides</option>
                <option value="9">9 slides</option>
                <option value="10">10 slides</option>
              </select>
            </div>

            <button
              class="btn"
              onclick="generateCustomStory()"
              id="generate-story-btn"
            >
              Generate Story
            </button>
          </div>

          <!-- Story Display -->
          <div id="story-display" class="story-display">
            <h3>üìñ Your Story</h3>
            <div id="story-content"></div>

            <button
              class="btn"
              onclick="startStoryImageGeneration()"
              id="start-story-generation-btn"
            >
              Generate Story Images
            </button>
          </div>

          <!-- Story Progress -->
          <div id="story-progress" class="progress-container">
            <div class="progress-text">Generating your story images...</div>
            <div class="progress-bar">
              <div class="progress-fill" id="story-progress-fill"></div>
            </div>
            <div id="story-progress-text">Preparing...</div>
          </div>

          <!-- Story Results -->
          <div id="story-results" class="results-container">
            <h3>üé® Your Story Images</h3>
            <div id="story-images-grid" class="image-grid"></div>

            <div class="download-section" id="story-download-section">
              <h4>üì• Download Your Story</h4>
              <p>
                Your story images are ready! Click below to download all images
                and story text as a ZIP file.
              </p>
              <button class="btn" onclick="downloadStoryZip()">
                Download Story ZIP
              </button>
            </div>
          </div>
        </div>

        <!-- Manual Prompts Mode -->
        <div id="manual-mode" class="mode-content">
          <div class="section">
            <h3>üé≠ Upload Your Avatar</h3>
            <div class="file-upload">
              <input
                type="file"
                id="avatar"
                accept="image/*"
                onchange="previewAvatar()"
              />
              <label for="avatar" class="file-upload-label">
                <div>üì∏ Click to upload your avatar</div>
                <small>PNG, JPG, or GIF (max 10MB)</small>
              </label>
            </div>
            <div id="avatar-preview" class="avatar-preview">
              <img id="avatar-img" src="" alt="Avatar preview" />
              <p>Avatar uploaded successfully!</p>
            </div>
          </div>

          <div class="section">
            <h3>
              ‚úèÔ∏è Your Story Prompts
              <button class="add-prompt-btn" onclick="addPrompt()">
                <span>+</span> Add Prompt
              </button>
            </h3>
            <div id="prompts-container">
              <div class="prompt-container">
                <div class="prompt-number">1</div>
                <textarea
                  placeholder="Describe the scene you want to create with your avatar..."
                  name="prompt_1"
                ></textarea>
              </div>
            </div>
          </div>

          <div class="section">
            <button class="btn" onclick="generateImages()" id="generate-btn">
              üé® Generate Images
            </button>
          </div>

          <!-- Progress Section -->
          <div id="progress-container" class="progress-container">
            <div class="progress-text">Generating your images...</div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="progress-text">Preparing...</div>
          </div>

          <!-- Results Section -->
          <div id="results-container" class="results-container">
            <h3>üé® Your Generated Images</h3>
            <div id="images-grid" class="image-grid"></div>

            <div class="download-section" id="download-section">
              <h4>üì• Download Your Images</h4>
              <p>
                Your images are ready! Click below to download all images as a
                ZIP file.
              </p>
              <button class="btn" onclick="downloadZip()">Download ZIP</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentMode = "story";
      let categories = {};
      let currentStory = null;
      let storySessionId = null;
      let storyImages = [];
      let sessionId = null;
      let generatedImages = [];
      let promptCount = 1;

      // Initialize app
      document.addEventListener("DOMContentLoaded", function () {
        loadCategories();
      });

      // Mode switching
      function switchMode(mode) {
        currentMode = mode;

        // Update buttons
        document.querySelectorAll(".mode-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // Update content
        document.querySelectorAll(".mode-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(mode + "-mode").classList.add("active");
      }

      // Load categories from API
      async function loadCategories() {
        try {
          const response = await fetch("/api/categories");
          const data = await response.json();

          if (data.success) {
            categories = data.categories;
            populateCategorySelect();
          } else {
            console.error("Failed to load categories");
          }
        } catch (error) {
          console.error("Error loading categories:", error);
        }
      }

      // Populate category select
      function populateCategorySelect() {
        const categorySelect = document.getElementById("category");
        categorySelect.innerHTML =
          '<option value="">Select a category...</option>';

        Object.keys(categories).forEach((category) => {
          const option = document.createElement("option");
          option.value = category;
          option.textContent = category.replace(/_/g, " ");
          categorySelect.appendChild(option);
        });
      }

      // Update subcategories based on selected category
      function updateSubcategories() {
        const categorySelect = document.getElementById("category");
        const subcategorySelect = document.getElementById("subcategory");
        const selectedCategory = categorySelect.value;

        subcategorySelect.innerHTML =
          '<option value="">Select a theme...</option>';

        if (selectedCategory && categories[selectedCategory]) {
          subcategorySelect.disabled = false;

          categories[selectedCategory].forEach((subcategory) => {
            const option = document.createElement("option");
            option.value = subcategory;
            option.textContent = subcategory.replace(/_/g, " ");
            subcategorySelect.appendChild(option);
          });
        } else {
          subcategorySelect.disabled = true;
        }
      }

      // Generate random story
      async function generateRandomStory() {
        const generateBtn = document.querySelector(".btn-secondary");
        const originalText = generateBtn.textContent;
        generateBtn.textContent = "Generating...";
        generateBtn.disabled = true;

        try {
          const numSlides = document.getElementById("num-slides").value;

          const response = await fetch("/api/generate-story", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              use_random: true,
              num_slides: parseInt(numSlides),
            }),
          });

          const data = await response.json();

          if (data.success) {
            currentStory = data.story;
            displayStory(data.story);
          } else {
            alert("Error generating story: " + data.error);
          }
        } catch (error) {
          console.error("Error generating random story:", error);
          alert("Error generating story. Please try again.");
        } finally {
          generateBtn.textContent = originalText;
          generateBtn.disabled = false;
        }
      }

      // Generate custom story
      async function generateCustomStory() {
        const category = document.getElementById("category").value;
        const subcategory = document.getElementById("subcategory").value;
        const numSlides = document.getElementById("num-slides").value;

        if (!category || !subcategory) {
          alert("Please select both a category and theme.");
          return;
        }

        const generateBtn = document.getElementById("generate-story-btn");
        const originalText = generateBtn.textContent;
        generateBtn.textContent = "Generating...";
        generateBtn.disabled = true;

        try {
          const response = await fetch("/api/generate-story", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              category: category,
              subcategory: subcategory,
              num_slides: parseInt(numSlides),
              use_random: false,
            }),
          });

          const data = await response.json();

          if (data.success) {
            currentStory = data.story;
            displayStory(data.story);
          } else {
            alert("Error generating story: " + data.error);
          }
        } catch (error) {
          console.error("Error generating custom story:", error);
          alert("Error generating story. Please try again.");
        } finally {
          generateBtn.textContent = originalText;
          generateBtn.disabled = false;
        }
      }

      // Display generated story
      function displayStory(story) {
        const storyDisplay = document.getElementById("story-display");
        const storyContent = document.getElementById("story-content");

        let html = `
            <div class="story-slide">
                <h4>üìñ ${story.story_title}</h4>
                <p style="color: #b1b1b1; margin-bottom: 15px;">
                    Category: ${story.category.replace(
                      /_/g,
                      " "
                    )} | Theme: ${story.subcategory.replace(/_/g, " ")}
                </p>
            </div>
        `;

        // Display the base prompt used to generate the story
        if (story.base_prompt) {
          html += `
                <div class="story-slide" style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.2);">
                    <h4 style="color: #667eea;">ü§ñ Base Prompt Sent to GPT</h4>
                    <div style="color: #b1b1b1; font-size: 12px; line-height: 1.4; white-space: pre-wrap; font-family: monospace; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 10px;">${story.base_prompt}</div>
                </div>
            `;
        }

        story.slides.forEach((slide, index) => {
          html += `
                <div class="story-slide">
                    <h4>Slide ${slide.slide_number}</h4>
                    <div class="story-text">${slide.story_text}</div>
                    <div class="story-image" id="story-image-${index}">
                        <div class="image-prompt-placeholder" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2); padding: 15px; border-radius: 10px; margin: 15px 0;">
                            <h5 style="color: #ffc107; margin-bottom: 10px;">üé® Image Generation Prompt:</h5>
                            <div style="color: #b1b1b1; font-size: 12px; line-height: 1.4; font-family: monospace;">${slide.image_prompt}</div>
                        </div>
                        <div class="loading">Waiting for image generation</div>
                    </div>
              </div>
            `;
        });

        storyContent.innerHTML = html;
        storyDisplay.style.display = "block";

        // Scroll to story
        storyDisplay.scrollIntoView({ behavior: "smooth" });
      }

      // Preview story avatar
      function previewStoryAvatar() {
        const file = document.getElementById("story-avatar").files[0];
        const preview = document.getElementById("story-avatar-preview");
        const img = document.getElementById("story-avatar-img");
        const storyCreationSection = document.getElementById(
          "story-creation-section"
        );

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            img.src = e.target.result;
            preview.style.display = "block";

            // Show story creation section after avatar upload
            storyCreationSection.style.display = "block";

            // Scroll to story creation section
            storyCreationSection.scrollIntoView({ behavior: "smooth" });
          };
          reader.readAsDataURL(file);
        }
      }

      // Start story image generation
      async function startStoryImageGeneration() {
        if (!currentStory) {
          alert("Please generate a story first.");
          return;
        }

        const avatarFile = document.getElementById("story-avatar").files[0];
        if (!avatarFile) {
          alert("Please upload an avatar image first.");
          return;
        }

        const startBtn = document.getElementById("start-story-generation-btn");
        startBtn.disabled = true;
        startBtn.textContent = "Initializing...";

        try {
          // Initialize story session with avatar
          const formData = new FormData();
          formData.append("avatar", avatarFile);
          formData.append("story_data", JSON.stringify(currentStory));

          const response = await fetch("/api/generate-story-session", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            storySessionId = data.session_id;
            await generateStoryImages();
          } else {
            alert("Error initializing story session: " + data.error);
          }
        } catch (error) {
          console.error("Error starting story generation:", error);
          alert("Error starting story generation. Please try again.");
        } finally {
          startBtn.disabled = false;
          startBtn.textContent = "Generate Story Images";
        }
      }

      // Generate all story images
      async function generateStoryImages() {
        const progressContainer = document.getElementById("story-progress");
        const progressFill = document.getElementById("story-progress-fill");
        const progressText = document.getElementById("story-progress-text");
        const resultsContainer = document.getElementById("story-results");
        const imagesGrid = document.getElementById("story-images-grid");

        progressContainer.style.display = "block";
        storyImages = [];

        const totalSlides = currentStory.slides.length;

        for (let i = 0; i < totalSlides; i++) {
          const slide = currentStory.slides[i];
          const progress = ((i + 1) / totalSlides) * 100;

          progressFill.style.width = `${progress}%`;
          progressText.textContent = `Generating image ${
            i + 1
          } of ${totalSlides}...`;

          try {
            const response = await fetch(
              `/api/generate-story-image/${storySessionId}/${slide.slide_number}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  image_prompt: slide.image_prompt,
                  story_text: slide.story_text,
                }),
              }
            );

            const data = await response.json();

            if (data.success) {
              storyImages.push(data);

              // Update story display with generated image
              const imageContainer = document.getElementById(
                `story-image-${i}`
              );
              const promptPlaceholder = imageContainer.querySelector(
                ".image-prompt-placeholder"
              );

              imageContainer.innerHTML = `
                  <div class="image-prompt-placeholder" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2); padding: 15px; border-radius: 10px; margin: 15px 0;">
                      <h5 style="color: #ffc107; margin-bottom: 10px;">üé® Image Generation Prompt:</h5>
                      <div style="color: #b1b1b1; font-size: 12px; line-height: 1.4; font-family: monospace;">${data.image_prompt}</div>
                  </div>
                  <img src="data:image/jpeg;base64,${data.image_base64}" alt="Story slide ${data.slide_number}" style="max-width: 100%; border-radius: 10px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);" />
              `;

              // Add to results grid
              const imageCard = document.createElement("div");
              imageCard.className = "image-card";
              imageCard.innerHTML = `
                  <img src="data:image/jpeg;base64,${data.image_base64}" alt="Story slide ${data.slide_number}" />
                  <div class="prompt-text">Slide ${data.slide_number}: ${data.story_text}</div>
              `;
              imagesGrid.appendChild(imageCard);
            } else {
              console.error("Error generating image:", data.error);
              const imageContainer = document.getElementById(
                `story-image-${i}`
              );
              const promptPlaceholder = imageContainer.querySelector(
                ".image-prompt-placeholder"
              );

              imageContainer.innerHTML = `
                  <div class="image-prompt-placeholder" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2); padding: 15px; border-radius: 10px; margin: 15px 0;">
                      <h5 style="color: #ffc107; margin-bottom: 10px;">üé® Image Generation Prompt:</h5>
                      <div style="color: #b1b1b1; font-size: 12px; line-height: 1.4; font-family: monospace;">${slide.image_prompt}</div>
                  </div>
                  <div style="color: #ef4444; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">Error generating image: ${data.error}</div>
              `;
            }
          } catch (error) {
            console.error("Error generating story image:", error);
            const imageContainer = document.getElementById(`story-image-${i}`);
            const slide = currentStory.slides[i];

            imageContainer.innerHTML = `
                <div class="image-prompt-placeholder" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h5 style="color: #ffc107; margin-bottom: 10px;">üé® Image Generation Prompt:</h5>
                    <div style="color: #b1b1b1; font-size: 12px; line-height: 1.4; font-family: monospace;">${slide.image_prompt}</div>
                </div>
                <div style="color: #ef4444; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">Error generating image: ${error.message}</div>
            `;
          }
        }

        progressContainer.style.display = "none";
        resultsContainer.style.display = "block";
        document.getElementById("story-download-section").style.display =
          "block";

        // Scroll to results
        resultsContainer.scrollIntoView({ behavior: "smooth" });
      }

      // Download story ZIP
      async function downloadStoryZip() {
        if (!storySessionId || storyImages.length === 0) {
          alert("No story images to download.");
          return;
        }

        try {
          const zip = new JSZip();

          // Add story text file
          const storyText = generateStoryText();
          zip.file("story.txt", storyText);

          // Add story JSON
          zip.file("story.json", JSON.stringify(currentStory, null, 2));

          // Add images
          for (let i = 0; i < storyImages.length; i++) {
            const imageData = storyImages[i];
            const imageBlob = await fetch(
              `data:image/jpeg;base64,${imageData.image_base64}`
            ).then((r) => r.blob());
            zip.file(imageData.filename, imageBlob);
          }

          // Add avatar
          try {
            const avatarResponse = await fetch(`/get-avatar/${storySessionId}`);
            const avatarData = await avatarResponse.json();
            if (avatarData.success) {
              const avatarBlob = await fetch(
                `data:image/jpeg;base64,${avatarData.avatar_base64}`
              ).then((r) => r.blob());
              zip.file(avatarData.filename, avatarBlob);
            }
          } catch (error) {
            console.error("Error adding avatar to ZIP:", error);
          }

          // Generate and download ZIP
          const zipBlob = await zip.generateAsync({ type: "blob" });
          const filename = `${currentStory.story_title.replace(
            /[^a-zA-Z0-9]/g,
            "_"
          )}_story.zip`;
          saveAs(zipBlob, filename);

          // Cleanup session
          try {
            await fetch(`/cleanup/${storySessionId}`, { method: "POST" });
          } catch (error) {
            console.error("Error cleaning up session:", error);
          }
        } catch (error) {
          console.error("Error creating ZIP file:", error);
          alert("Error creating ZIP file. Please try again.");
        }
      }

      // Generate story text for download
      function generateStoryText() {
        let text = `${currentStory.story_title}\n`;
        text += `Category: ${currentStory.category.replace(/_/g, " ")}\n`;
        text += `Theme: ${currentStory.subcategory.replace(/_/g, " ")}\n`;
        text += `\n${"=".repeat(50)}\n\n`;

        currentStory.slides.forEach((slide, index) => {
          text += `Slide ${slide.slide_number}\n`;
          text += `${"-".repeat(20)}\n`;
          text += `${slide.story_text}\n\n`;
        });

        return text;
      }

      // EXISTING MANUAL MODE FUNCTIONS
      function previewAvatar() {
        const file = document.getElementById("avatar").files[0];
        const preview = document.getElementById("avatar-preview");
        const img = document.getElementById("avatar-img");

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            img.src = e.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      }

      function addPrompt() {
        promptCount++;
        const container = document.getElementById("prompts-container");
        const promptDiv = document.createElement("div");
        promptDiv.className = "prompt-container";
        promptDiv.innerHTML = `
                <div class="prompt-number">${promptCount}</div>
                <textarea placeholder="Describe the scene you want to create with your avatar..." name="prompt_${promptCount}"></textarea>
                <div class="remove-prompt-btn" onclick="removePrompt(this)">√ó</div>
            `;
        container.appendChild(promptDiv);
      }

      function removePrompt(button) {
        const container = button.parentElement;
        container.remove();
        updatePromptNumbers();
      }

      function updatePromptNumbers() {
        const prompts = document.querySelectorAll(".prompt-container");
        prompts.forEach((prompt, index) => {
          const numberDiv = prompt.querySelector(".prompt-number");
          const textarea = prompt.querySelector("textarea");
          numberDiv.textContent = index + 1;
          textarea.name = `prompt_${index + 1}`;
        });
        promptCount = prompts.length;
      }

      async function generateImages() {
        const avatarFile = document.getElementById("avatar").files[0];
        const prompts = document.querySelectorAll(
          "#prompts-container textarea"
        );

        if (!avatarFile) {
          alert("Please upload an avatar image.");
          return;
        }

        const promptTexts = Array.from(prompts)
          .map((p) => p.value.trim())
          .filter((p) => p);
        if (promptTexts.length === 0) {
          alert("Please add at least one prompt.");
          return;
        }

        const generateBtn = document.getElementById("generate-btn");
        generateBtn.disabled = true;
        generateBtn.textContent = "Generating...";

        try {
          // Initialize session
          const formData = new FormData();
          formData.append("avatar", avatarFile);
          promptTexts.forEach((prompt, index) => {
            formData.append(`prompt_${index + 1}`, prompt);
          });

          const response = await fetch("/generate-stream", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.session_id) {
            sessionId = data.session_id;
            await generateAllImages(data.prompts);
          } else {
            alert("Error: " + data.error);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error generating images. Please try again.");
        } finally {
          generateBtn.disabled = false;
          generateBtn.textContent = "üé® Generate Images";
        }
      }

      async function generateAllImages(prompts) {
        const progressContainer = document.getElementById("progress-container");
        const progressFill = document.getElementById("progress-fill");
        const progressText = document.getElementById("progress-text");
        const resultsContainer = document.getElementById("results-container");
        const imagesGrid = document.getElementById("images-grid");

        progressContainer.style.display = "block";
        imagesGrid.innerHTML = "";
        generatedImages = [];

        const totalPrompts = prompts.length;

        for (let i = 0; i < totalPrompts; i++) {
          const progress = ((i + 1) / totalPrompts) * 100;
          progressFill.style.width = `${progress}%`;
          progressText.textContent = `Generating image ${
            i + 1
          } of ${totalPrompts}...`;

          try {
            const response = await fetch(
              `/generate-single/${sessionId}/${i + 1}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ prompt: prompts[i] }),
              }
            );

            const data = await response.json();

            if (data.success) {
              generatedImages.push(data);

              const imageCard = document.createElement("div");
              imageCard.className = "image-card";
              imageCard.innerHTML = `
                            <img src="data:image/jpeg;base64,${
                              data.image_base64
                            }" alt="Generated image ${i + 1}" />
                            <div class="prompt-text">${data.prompt}</div>
                        `;
              imagesGrid.appendChild(imageCard);
            } else {
              console.error("Error generating image:", data.error);
            }
          } catch (error) {
            console.error("Error generating image:", error);
          }
        }

        progressContainer.style.display = "none";
        resultsContainer.style.display = "block";
        document.getElementById("download-section").style.display = "block";

        resultsContainer.scrollIntoView({ behavior: "smooth" });
      }

      async function downloadZip() {
        if (!sessionId || generatedImages.length === 0) {
          alert("No images to download.");
          return;
        }

        try {
          const zip = new JSZip();

          // Add generated images
          for (let i = 0; i < generatedImages.length; i++) {
            const imageData = generatedImages[i];
            const imageBlob = await fetch(
              `data:image/jpeg;base64,${imageData.image_base64}`
            ).then((r) => r.blob());
            zip.file(imageData.filename, imageBlob);
          }

          // Add avatar
          try {
            const avatarResponse = await fetch(`/get-avatar/${sessionId}`);
            const avatarData = await avatarResponse.json();
            if (avatarData.success) {
              const avatarBlob = await fetch(
                `data:image/jpeg;base64,${avatarData.avatar_base64}`
              ).then((r) => r.blob());
              zip.file(avatarData.filename, avatarBlob);
            }
          } catch (error) {
            console.error("Error adding avatar to ZIP:", error);
          }

          // Generate and download ZIP
          const zipBlob = await zip.generateAsync({ type: "blob" });
          saveAs(zipBlob, "generated_images.zip");

          // Cleanup session
          try {
            await fetch(`/cleanup/${sessionId}`, { method: "POST" });
          } catch (error) {
            console.error("Error cleaning up session:", error);
          }
        } catch (error) {
          console.error("Error creating ZIP file:", error);
          alert("Error creating ZIP file. Please try again.");
        }
      }
    </script>
  </body>
</html>
